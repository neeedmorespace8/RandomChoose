<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>隨機轉盤</title>
    <style>
        /* --- General Page Styles --- */
        :root {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --primary-accent-color: #3498db;
            --danger-color: #e74c3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--primary-text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100svh;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Main Container --- */
        .container {
            width: 100%;
            max-width: 480px;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            display: flex;
            flex-direction: column;
            height: 100svh;
        }

        h2.title {
            color: var(--primary-text-color);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* --- Wheel & Pointer --- */
        .wheel-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 320px;
            max-height: 320px;
            margin: 20px auto;
            flex-shrink: 0;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
            transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 35px solid var(--danger-color);
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            z-index: 10;
        }

        /* --- Result Display --- */
        #result {
            margin-top: 5px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-text-color);
            min-height: 1.8em;
            padding: 5px;
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Controls --- */
        .controls {
            margin-top: 0;
            padding-top: 10px;
        }

        button {
            width: 100%;
            padding: 13px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #spinButton {
             background-color: var(--primary-accent-color);
             margin-top: 10px;
        }
        
        #editOptionsButton {
            background-color: var(--surface-color);
            color: var(--primary-accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Options Modal --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-container {
            background-color: var(--background-color);
            width: 100%;
            max-width: 480px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow: hidden;
            border: 2px solid var(--primary-accent-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--surface-color);
            flex-shrink: 0;
        }
        
        .modal-header button {
            width: auto;
            padding: 5px 15px;
            font-size: 1em;
            background: none;
            color: var(--primary-accent-color);
            font-weight: normal;
        }
        
        .modal-header h3 { margin: 0; }
        
        .modal-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .question-input-group {
            display: flex;
            align-items: center;
            background-color: var(--surface-color);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .question-input-group span {
            font-size: 1.5em;
            margin-right: 10px;
        }
        #questionInput {
            background: none;
            border: none;
            color: var(--primary-text-color);
            font-size: 1em;
            width: 100%;
        }
        #questionInput:focus { outline: none; }
        #optionsList { list-style: none; padding: 0; margin: 0; }
        
        .option-item {
            display: flex;
            align-items: center;
            background-color: var(--surface-color);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap; 
            justify-content: space-between;
        }
        
        .option-item .remove-btn {
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 18px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            padding: 0;
            margin-right: 10px;
            border: none;
            flex-shrink: 0;
        }
        
        .option-item input.name-input {
            background: none;
            border: none;
            color: var(--primary-text-color);
            font-size: 1em;
            padding: 10px 5px;
            flex-grow: 1;
            flex-grow: 1;
            min-width: 0;
            max-width: 150px;
        }
        .option-item input.name-input:focus { outline: none; }

        .option-item .weight-input {
            width: 40px;
            background-color: #333;
            border: 1px solid #555;
            color: var(--primary-text-color);
            text-align: center;
            border-radius: 4px;
            margin: 0 10px;
            -moz-appearance: textfield;
        }
        .option-item .weight-input::-webkit-outer-spin-button,
        .option-item .weight-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .option-item .weight-fraction {
            min-width: 40px;
            text-align: right;
            color: var(--secondary-text-color);
        }

        .weight-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-left: auto;
        }

        .name-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            margin-right: 10px;
        }

        #addOptionButton {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            font-weight: normal;
            background-color: transparent;
            color: var(--primary-accent-color);
            text-align: left;
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title" id="wheelTitle">隨機轉盤</h2>

        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="500" height="500"></canvas>
        </div>

        <div id="result">請設定選項</div>

        <div class="controls">
            <button id="editOptionsButton">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                    <rect x="3" y="6" width="18" height="2" rx="1"></rect>
                    <rect x="3" y="11" width="18" height="2" rx="1"></rect>
                    <rect x="3" y="16" width="18" height="2" rx="1"></rect>
                </svg>
                設定選項
            </button>
            <button id="spinButton" disabled>開始旋轉！</button>
        </div>
    </div>

    <div id="optionsModal" class="modal">
        <div class="modal-container">
            <div class="modal-header">
                <button id="cancelButton">取消</button>
                <h3>編輯選項</h3>
                <button id="saveButton">儲存</button>
            </div>
            <div class="modal-content">
                <div class="question-input-group">
                    <span>🤔</span>
                    <input type="text" id="questionInput" placeholder="請輸入標題">
                </div>
                
                <p>選項 (enter 可接續下一個選項)</p>
                <ul id="optionsList">
                    </ul>
                <button id="addOptionButton">+ 添加新選項</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const spinButton = document.getElementById('spinButton');
    const resultDiv = document.getElementById('result');
    const wheelTitle = document.getElementById('wheelTitle');
    const optionsModal = document.getElementById('optionsModal');
    const editOptionsButton = document.getElementById('editOptionsButton');
    const saveButton = document.getElementById('saveButton');
    const cancelButton = document.getElementById('cancelButton');
    const questionInput = document.getElementById('questionInput');
    const optionsList = document.getElementById('optionsList');
    const addOptionButton = document.getElementById('addOptionButton');

    let options = []; 
    let currentAngle = 0;
    let isSpinning = false;
    
    const colors = [
        '#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db',
        '#9b59b6', '#34495e', '#1abc9c', '#d35400', '#c0392b'
    ];

    const drawWheel = () => {
        const totalWeight = options.reduce((sum, opt) => sum + (opt.weight || 0), 0);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = canvas.width / 2 - 20;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (totalWeight === 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#333'; // 灰色
            ctx.fill();
            return;
        }
        
        ctx.font = '22px Arial';
        ctx.textBaseline = 'middle';
        ctx.textAlign = 'center';

        let startAngle = 0;
        for (let i = 0; i < options.length; i++) {
            const option = options[i];
            const arcSize = (2 * Math.PI) * (option.weight / totalWeight);
            if (arcSize <= 0) continue;
            const endAngle = startAngle + arcSize;
            
            ctx.beginPath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            ctx.fill();

            ctx.save();
            ctx.fillStyle = '#fff';
            const textAngle = startAngle + arcSize / 2;
            ctx.translate(
                centerX + Math.cos(textAngle) * radius * 0.6,
                centerY + Math.sin(textAngle) * radius * 0.6
            );
            ctx.rotate(textAngle + Math.PI / 2);
            
            const text = option.name;
            ctx.fillText(text.length > 8 ? text.substring(0, 7) + '…' : text, 0, 0);
            ctx.restore();

            startAngle = endAngle;
        }
    };
    
    const updateUIFromOptions = () => {
        wheelTitle.textContent = questionInput.value.trim() || "隨機轉盤";
        if (options.length > 1) {
            spinButton.disabled = false;
            resultDiv.textContent = '準備就緒！';
        } else {
            spinButton.disabled = true;
            resultDiv.textContent = options.length === 1 ? '請至少輸入兩個選項' : '請設定選項';
        }
        
        canvas.style.transition = 'none';
        currentAngle = 0;
        canvas.style.transform = `rotate(0deg)`;
        drawWheel();
    };
    
    const spin = () => {
        if (isSpinning || options.length < 2) return;
        isSpinning = true;
        spinButton.disabled = true;
        resultDiv.textContent = '轉動中...';

        const spinAngle = Math.random() * 360 + 360 * 5;
        const totalAngle = currentAngle + spinAngle;
        
        canvas.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.4, 1)';
        canvas.style.transform = `rotate(${totalAngle}deg)`;

        setTimeout(() => {
            const finalAngle = totalAngle % 360;
            const winningPointerAngle = (270 - finalAngle + 360) % 360;
            const totalWeight = options.reduce((sum, opt) => sum + (opt.weight || 1), 0);
            const anglePerWeightUnit = 360 / totalWeight;

            let cumulativeAngle = 0;
            let winnerIndex = -1;

            for (let i = 0; i < options.length; i++) {
                cumulativeAngle += options[i].weight * anglePerWeightUnit;
                if (winningPointerAngle <= cumulativeAngle) {
                    winnerIndex = i;
                    break;
                }
            }

            const winnerText = options[winnerIndex]?.name || '無結果';
            resultDiv.textContent = `恭喜： ${winnerText}`;
            
            currentAngle = finalAngle;
            canvas.style.transition = 'none';
            canvas.style.transform = `rotate(${currentAngle}deg)`;

            isSpinning = false;
            spinButton.disabled = false;
        }, 5000);
    };

    // --- Modal Logic ---

    const escapeHTML = str => String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');

    const updateOptionsFromDOM = () => {
        const newOptions = [];
        optionsList.querySelectorAll('.option-item').forEach(item => {
            const name = item.querySelector('.name-input').value;
            let weight = parseInt(item.querySelector('.weight-input').value, 10);
            if (isNaN(weight) || weight < 1) weight = 1;
            newOptions.push({ name, weight });
        });
        options = newOptions;
    };

    const renderOptionsEditor = () => {
        const totalWeight = options.reduce((sum, opt) => sum + (opt.weight || 1), 0) || 1;
        optionsList.innerHTML = ''; 

        options.forEach((option, index) => {
            const li = document.createElement('li');
            li.className = 'option-item';
            li.innerHTML = `
                <div class="name-container">
                    <button class="remove-btn" data-index="${index}">-</button>
                    <input type="text" class="name-input" data-index="${index}" value="${escapeHTML(option.name)}" placeholder="選項名稱" enterkeyhint="enter">
                </div>
                <div class="weight-container">
                    <input type="number" class="weight-input" value="${option.weight}" min="1">
                    <span class="weight-fraction">權重: ${option.weight || 1}/${totalWeight}</span>
                </div>
            `;
            optionsList.appendChild(li);
        });
        attachModalListeners();
    };

    const attachModalListeners = () => {
        optionsList.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                updateOptionsFromDOM();
                options.splice(indexToRemove, 1);
                renderOptionsEditor();
            });
        });

        optionsList.querySelectorAll('.name-input').forEach(input => {
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const currentIndex = parseInt(e.currentTarget.dataset.index, 10);
                    updateOptionsFromDOM();
                    options.splice(currentIndex + 1, 0, { name: '', weight: 1 });
                    renderOptionsEditor();
                    const nextInput = optionsList.querySelector(`.name-input[data-index="${currentIndex + 1}"]`);
                    if (nextInput) nextInput.focus();
                }
            });
        });
        
        optionsList.querySelectorAll('.weight-input').forEach(input => {
            input.addEventListener('input', () => {
                updateOptionsFromDOM();
                const totalWeight = options.reduce((sum, opt) => sum + (opt.weight || 1), 0) || 1;
                optionsList.querySelectorAll('.weight-fraction').forEach((span, index) => {
                    span.textContent = `${options[index].weight || 1}/${totalWeight}`;
                });
            });
        });
    };

    const openModal = () => {
        renderOptionsEditor();
        optionsModal.style.display = 'flex';
    };

    const closeModal = () => {
        optionsModal.style.display = 'none';
    };

    const saveOptions = () => {
        updateOptionsFromDOM();
        options = options.filter(opt => opt.name.trim() !== ''); 
        updateUIFromOptions();
        closeModal();
    };

    editOptionsButton.addEventListener('click', openModal);
    cancelButton.addEventListener('click', closeModal);
    saveButton.addEventListener('click', saveOptions);
    spinButton.addEventListener('click', spin);

    addOptionButton.addEventListener('click', () => {
        updateOptionsFromDOM(); 
        options.push({ name: '', weight: 1 }); 
        renderOptionsEditor(); 
        const inputs = optionsList.querySelectorAll('.name-input');
        if (inputs.length > 0) inputs[inputs.length - 1].focus();
    });

   // Initial setup
    updateUIFromOptions();
});
</script>
</body>
</html>